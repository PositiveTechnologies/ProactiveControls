# C4: Кодирование и экранирование данных

## Описание

Кодирование и экранирование являются методами защиты от внедрения кода. __Кодирование__ (обычно называемое "кодированием выходных данных") представляет собой преобразование специальных символов в эквивалентные и не опасные для интерпретатора комбинации, например преобразование символа "__<__" в сочетание "__\&lt;__" при его добавлении на __HTML-страницу__. __Экранирование__ заключается в добавлении спецсимволов перед символами или строками для предотвращения их некорректной интерпретации, например добавление символа \ перед двойными кавычками (") позволяет интерпретировать их в качестве части текста, а не в качестве обозначения окончания строки.

Кодирование лучше всего применять __непосредственно перед__ передачей данных интерпретатору. Если применить данный метод на слишком раннем этапе обработки запроса, то кодирование или экранирование может сказаться на использование контента в других частях программы. Например, если при перед сохранением в базе данных HTML-контент экранируется, а интерфейс автоматически экранирует эти данные еще раз, то содержимое не будет отображаться корректно из-за двойного экранирования.

## Контекстуальное кодирование выходных данных

Контекстуальное кодирование выходных данных является ключевым для безопасного программирования и предотвращения межсайтового выполнения сценариев. Подобная мера защиты применяется при создании интерфейсов пользователя, непосредственно перед динамическим добавлением непроверенных данных к HTML-коду. Тип кодирования будет зависеть от места (или контекста) отображения или хранения данных в документе. Типы кодирования, рекомендуемые к использованию при создании безопасного интерфейса: кодирование сущностей или атрибутов HTML, а также кодирование JavaScript и URL.

### Примеры кодирования Java

Примеры использования кодировщика Java, обеспечивающего контекстуальное кодирование выходных данных, можно посмотреть на сайте [проекта кодировщика Java от OWASP](https://www.owasp.org/index.php/OWASP_Java_Encoder_Project#tab=Use_the_Java_Encoder_Project).

### Примеры кодирования .NET

Начиная с .NET 4.5, библиотека антимежсайтового выполнения сценариев является частью фреймворка, но не используется по умолчанию. Вы можете назначить AntiXssEncoder из этой библиотеки в качестве стандартного кодировщика вашего приложения, изменив настройки web.conf. При кодировании выходных данных необходимо учитывать контекст, т. е. использовать соответствующую функцию из библиотеки AntiXSSEncoder в зависимости от расположения данных в документе.

### Примеры кодирования PHP

**Zend Framework 2**

В Zend Framework 2 (ZF2) для кодирования выходных данных может быть использован Zend\Escaper. Примеры контекстного кодирования можно посмотреть на странице, посвященной [контекстному экранированию с помощью zend-escaper](https://framework.zend.com/blog/2017-05-16-zend-escaper.html).

## Другие способы кодирования и защиты от внедрений

Кодирование или экранирование может быть использовано для предотвращения других форм внедрений в контент. Например, можно нейтрализовывать некоторые специальные метасимволы при вводе данных для системных команд. Это называют "экранированием команд ОС", "экранированием shell" и т. п. Подобная защита может быть использована для предотвращения "Внедрения команд".

Существуют и другие формы экранирования, которые могут быть использованы для предотвращения внедрений, например экранирование атрибутов XML, защищающее от различных форм внедрений XML и XML-путей, а также экранирование уникальных имен LDAP, позволяющее предотвратить различные LDAP-внедрения.

### Нормализация и кодировка символов

Кодировка Юникод — это способ хранения символов с использованием нескольких байтов. При вводе данных злоумышленник может использовать [Юникод](https://www.owasp.org/index.php/Unicode_Encoding), чтобы скрыть вредоносный код и получить возможность проведения различных атак. [RFC 2279](https://tools.ietf.org/html/rfc2279) описывает несколько способов кодировки текста.

Нормализация — это способ преобразования данных в простую или стандартную форму. В веб-приложениях нормализацию обычно используют для обеспечения единообразия символов всего контента при его хранении или отображении.

Защищенность от атак, связанных с нормализацией, означает отсутствие угроз безопасности приложения при вводе злоумышленником некорректно сформированных символов Юникода или любых других специально сформированных символов.

## Предотвращаемые уязвимости

* [Топ-10 OWASP 2017 - A1: Внедрение](https://www.owasp.org/index.php/Top_10-2017_A1-Injection)
* [Топ-10 OWASP 2017 - А7: Межсайтовое выполнение сценариев](https://www.owasp.org/index.php/Top_10-2017_A7-Cross-Site_Scripting_(XSS))
* [Топ-10 OWASP 2014 (мобильные устройства) - M7: Внедрение на стороне клиента](https://www.owasp.org/index.php/Mobile_Top_10_2014-M7)

## Ссылки

* [Межсайтовое выполнение сценариев](https://www.owasp.org/index.php/XSS) — общие сведения
* [Памятка OWASP: Предотвращение межсайтового выполнения сценариев](https://www.owasp.org/index.php/XSS_(Cross_Site_Scripting)_Prevention_Cheat_Sheet) — предотвращение XSS в веб-приложениях
* [Памятка OWASP: Предотвращение межсайтового выполнения сценариев на основе объектной модели документа](https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet)
* [Памятка OWASP: Предотвращение внедрений](https://www.owasp.org/index.php/Injection_Prevention_Cheat_Sheet)

## Инструменты

* [Проект кодировщика Java от OWASP](https://www.owasp.org/index.php/OWASP_Java_Encoder_Project)
* [AntiXSSEncoder](https://msdn.microsoft.com/en-us/library/system.web.security.antixss.antixssencoder(v=vs.110).aspx)
* [Zend\Escaper](https://framework.zend.com/blog/2017-05-16-zend-escaper.html) — примеры контекстного кодирования